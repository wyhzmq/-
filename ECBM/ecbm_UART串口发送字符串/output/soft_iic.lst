C51 COMPILER V9.01   SOFT_IIC                                                              07/19/2022 16:09:56 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE SOFT_IIC
OBJECT MODULE PLACED IN .\output\soft_iic.obj
COMPILER INVOKED BY: D:\Paths\Keil_v5\C51\BIN\C51.EXE ECBM_LIB\soft_iic.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\ECBM_L
                    -IB;.\device) DEBUG OBJECTEXTEND PRINT(.\output\soft_iic.lst) OBJECT(.\output\soft_iic.obj)

line level    source

   1          #include "ecbm_core.h"//Í³Ò»¼ÓÔØºËÐÄÍ·ÎÄ¼þ
   2          #if ECBM_SOFTIIC_LIB_EN//¼ì²é±¾¿âÓÐÃ»ÓÐ±»Ê¹ÄÜ
              /*--------------------------------------±äÁ¿¶¨Òå-----------------------------------*/
              u8 idata soft_iic_def_sda_port;
              u8 idata soft_iic_def_sda_pin;
              u8 idata soft_iic_def_scl_port;
              u8 idata soft_iic_def_scl_pin;
              u8 idata soft_iic_max=0;
              u8 idata soft_iic_index=0;
              /*--------------------------------------³ÌÐò¶¨Òå-----------------------------------*/
              /*-------------------------------------------------------
              Èí¼þIICÒý½ÅÇÐ»»º¯Êý¡£
              -------------------------------------------------------*/
              void soft_iic_set_pin(soft_iic_def * dev){
                  if(soft_iic_index!=dev->dev_id){
                      soft_iic_def_scl_port=io2port(dev->scl_pin);
                      soft_iic_def_scl_pin =io2pin (dev->scl_pin);
                      soft_iic_def_sda_port=io2port(dev->sda_pin);
                      soft_iic_def_sda_pin =io2pin (dev->sda_pin);
                      soft_iic_index=dev->dev_id;
                  }    
              }
              /*-------------------------------------------------------
              Èí¼þIIC³õÊ¼»¯º¯Êý¡£
              -------------------------------------------------------*/
              void soft_iic_init(soft_iic_def * dev,u8 scl,u8 sda){
                  dev->scl_pin=scl;
                  dev->sda_pin=sda;
                  gpio_mode   (scl,GPIO_OD);//IICµÄÒý½ÅÐèÒªÊÇ¿ªÂ©Ä£Ê½
                  gpio_mode   (sda,GPIO_OD);//IICµÄÒý½ÅÐèÒªÊÇ¿ªÂ©Ä£Ê½
                  gpio_uppull (scl,1);    //IICÐèÒªÒ»¸öÉÏÀ­µç×è
                  gpio_uppull (sda,1);    //IICÐèÒªÒ»¸öÉÏÀ­µç×è
                  gpio_out    (scl,1);
                  gpio_out    (sda,1);
                  dev->dev_id =++soft_iic_max;
                  soft_iic_set_pin(dev);
              }
              /*-------------------------------------------------------
              Èí¼þIICÒý½ÅÇÐ»»º¯Êý£¨ÄÚÁª°æ£©¡£
              -------------------------------------------------------*/
              void soft_iic_set_pin_linkage(u8 id,u8 scl,u8 sda){
                  if(soft_iic_index!=id){
                      soft_iic_def_scl_port=io2port(scl);
                      soft_iic_def_scl_pin =io2pin (scl);
                      soft_iic_def_sda_port=io2port(sda);
                      soft_iic_def_sda_pin =io2pin (sda);
                      soft_iic_index=id;
                  }    
              }
              /*-------------------------------------------------------
              Èí¼þIIC³õÊ¼»¯º¯Êý£¨ÄÚÁª°æ£©¡£
              -------------------------------------------------------*/
              u8 soft_iic_init_linkage(u8 scl,u8 sda){
                  u8 id;
C51 COMPILER V9.01   SOFT_IIC                                                              07/19/2022 16:09:56 PAGE 2   

                  gpio_mode   (scl,GPIO_OD);//IICµÄÒý½ÅÐèÒªÊÇ¿ªÂ©Ä£Ê½
                  gpio_mode   (sda,GPIO_OD);//IICµÄÒý½ÅÐèÒªÊÇ¿ªÂ©Ä£Ê½
                  gpio_uppull (scl,1);      //IICÐèÒªÒ»¸öÉÏÀ­µç×è
                  gpio_uppull (sda,1);      //IICÐèÒªÒ»¸öÉÏÀ­µç×è
                  gpio_out    (scl,1);      //À­¸ßIIC×ÜÏß
                  gpio_out    (sda,1);
                  id =++soft_iic_max;
                  soft_iic_set_pin_linkage(id,scl,sda);
                  return id;
              }
              /*-------------------------------------------------------
              Èí¼þIICÆô¶¯º¯Êý¡£
              -------------------------------------------------------*/
              u8 soft_iic_start(void){
                  gpio_out_fast   (soft_iic_def_sda_port,soft_iic_def_sda_pin,1);
                  gpio_out_fast   (soft_iic_def_scl_port,soft_iic_def_scl_pin,1);
                  if(gpio_in_fast (soft_iic_def_sda_port,soft_iic_def_sda_pin)==0)return -1;/* SDAÏßÎªµÍµçÆ½Ôò×ÜÏßÃ¦,ÍË³
             -ö */
                  gpio_toggle_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin);
                  if(gpio_in_fast (soft_iic_def_sda_port,soft_iic_def_sda_pin)==1)return -1;/* SDAÏßÎª¸ßµçÆ½Ôò×ÜÏß³ö´í,Í
             -Ë³ö */
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  return 0;
              }
              /*-------------------------------------------------------
              Èí¼þIICÍ£Ö¹º¯Êý¡£
              -------------------------------------------------------*/
              void soft_iic_stop(void){
                  gpio_out_fast   (soft_iic_def_sda_port,soft_iic_def_sda_pin,0);
                  gpio_out_fast   (soft_iic_def_scl_port,soft_iic_def_scl_pin,0);
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  gpio_toggle_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin);
              }
              /*-------------------------------------------------------
              Èí¼þIICÖ÷»úÐ´ACKº¯Êý¡£
              -------------------------------------------------------*/
              void soft_iic_write_ack(void){
                  gpio_out_fast   (soft_iic_def_scl_port,soft_iic_def_scl_pin,0);
                  gpio_out_fast   (soft_iic_def_sda_port,soft_iic_def_sda_pin,0);
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
              }
              /*-------------------------------------------------------
              Èí¼þIICÖ÷»úÐ´NO ACKº¯Êý¡£
              -------------------------------------------------------*/
              void soft_iic_write_nack(void){
                  gpio_out_fast   (soft_iic_def_scl_port,soft_iic_def_scl_pin,0);
                  gpio_out_fast   (soft_iic_def_sda_port,soft_iic_def_sda_pin,1);
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
              }
              /*-------------------------------------------------------
              Èí¼þIICÖ÷»ú¶ÁACKº¯Êý¡£
              -------------------------------------------------------*/
              u8 soft_iic_read_ack(void){
                  gpio_out_fast   (soft_iic_def_scl_port,soft_iic_def_scl_pin,0);
                  gpio_out_fast   (soft_iic_def_sda_port,soft_iic_def_sda_pin,1);
                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  if(gpio_in_fast (soft_iic_def_sda_port,soft_iic_def_sda_pin)==1){
                      gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                      return -1;
                  }
C51 COMPILER V9.01   SOFT_IIC                                                              07/19/2022 16:09:56 PAGE 3   

                  gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  return 0;
              }
              /*-------------------------------------------------------
              Èí¼þIICÖ÷»úÐ´º¯Êý¡£
              -------------------------------------------------------*/
              void soft_iic_write(u8 dat){
                  u8 i,old;
                  old=dat;
                  if(dat&0x80){
                      gpio_out_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin,1);
                  }else{
                      gpio_out_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin,0);
                  }
                  gpio_out_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin,0);
                  for(i=0;i<8;i++){
                      if((old^dat)&0x80){
                          gpio_toggle_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin);
                      }
                      gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                      old=dat;
                      dat<<=1;
                      gpio_toggle_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin);
                  }
              }
              /*-------------------------------------------------------
              Èí¼þIICÖ÷»ú¶Áº¯Êý¡£
              -------------------------------------------------------*/
              u8 soft_iic_read(void){
                  u8 i,dat;
                  dat=0;
                  gpio_out_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin,1);
                  for(i=0;i<8;i++){
                      dat<<=1;
                      gpio_out_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin,1);
                      if(gpio_in_fast(soft_iic_def_sda_port,soft_iic_def_sda_pin)==1){
                          dat|=0x01;
                      }
                      gpio_out_fast(soft_iic_def_scl_port,soft_iic_def_scl_pin,0);
                  }
                  return dat;
              }
              /*-------------------------------------------------------
              Èí¼þIICÖ÷»úÑ°ÕÒº¯Êý¡£
              -------------------------------------------------------*/
              #if SOFT_IIC_FIND_EN == 1
              u8 soft_iic_find(u8 addr[]){
                  u8 i,c;
                  c=0;
                  for(i=0;i<128;i++){
                      soft_iic_start();
                      soft_iic_write(i<<1);
                      if(soft_iic_read_ack()==0){
                          addr[c]=(i<<1);
                          c++;
                      }
                      soft_iic_stop();
                  }    
                  return c;
              }
              #endif
              #endif  //ºÍ×îÉÏÃæµÄ#ifndefÅäºÏ³ÉÒ»¸ö³ÌÐò¶Î¡£
C51 COMPILER V9.01   SOFT_IIC                                                              07/19/2022 16:09:56 PAGE 4   

 177                  //ÒÔÒ»¸ö¿ÕÐÐÎª½áÎ²¡£


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
