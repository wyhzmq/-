C51 COMPILER V9.01   STREAM_XMODEM                                                         07/18/2022 16:31:20 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE STREAM_XMODEM
OBJECT MODULE PLACED IN .\output\stream_xmodem.obj
COMPILER INVOKED BY: D:\Paths\Keil_v5\C51\BIN\C51.EXE device\stream_xmodem.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\ECB
                    -M_LIB;.\device) DEBUG OBJECTEXTEND PRINT(.\output\stream_xmodem.lst) OBJECT(.\output\stream_xmodem.obj)

line level    source

   1          #include "stream_xmodem.h"//¼ÓÔØÍ·ÎÄ¼þ
   2          #if ECBM_STREAM_XMODEM_EN//¼ì²é±¾¿âÓÐÃ»ÓÐ±»Ê¹ÄÜ
              /*--------------------------------------±äÁ¿¶¨Òå-----------------------------------*/
              u8    es_xmodem_buf_start  =0; //xmodemµÄÊý¾ÝÔÚ»º´æÖÐµÄ¿ªÊ¼Î»ÖÃ¡£
              u8    es_xmodem_sum        =0; //Ð£ÑéºÍ¡£
              u8    es_xmodem_pack       =0; //Êý¾Ý°ü±àºÅ¡£
              u8    es_xmodem_status     =0; //Xmodem×´Ì¬»ú×´Ì¬¡£
              u8    es_xmodem_count      =0; //½ÓÊÕÊý¾Ý¼ÆÊý¡£
              /*--------------------------------------³ÌÐò¶¨Òå-----------------------------------*/
              /*-------------------------------------------------------
              xmodem¿ªÊ¼½ÓÊÕº¯Êý¡£
              -------------------------------------------------------*/
              void es_xmodem_start(void){             //¿ªÆôº¯Êý£¬ÓÃÓÚ¿ªÊ¼´«ÊäÊý¾Ý¡£
                  es_xmodem_pack=0;                   //Çå³ý°ü±àºÅ¡£
                  es_xmodem_status=ES_XMODEM_READY;   //×ªµ½¾ÍÐ÷Ì¬¡£
                  uart_char(ECBM_STREAM_UART,ES_XMODEM_NAK);     //·¢ËÍNACK£¬Í¨ÖªÉÏÎ»»ú¿ªÊ¼Í¨ÐÅ¡£
              }
              /*-------------------------------------------------------
              Êý¾Ý½ÓÊÕº¯Êý¡£
              -------------------------------------------------------*/
              void es_xmodem_exe(u8 dat){
                  u8 i;
                  switch(es_xmodem_status){
                      case ES_XMODEM_READY:{//¾ÍÐ÷×´Ì¬¡£
                          if(dat==ES_XMODEM_SOH){                     //Èç¹ûÊÕµ½SOH×Ö¶Î£¬
                              es_xmodem_status=ES_XMODEM_READ_PACK;   //Ìøµ½¶ÁÈ¡°ü±àºÅ¡£
                              es_xmodem_sum=dat;                      //´ÓÕâÀï¾Í¿ªÊ¼¼ÆËãÐ£ÑéºÍ¡£
                          }else if(dat==ES_XMODEM_EOT){               //Èç¹ûÊÕµ½EOT×Ö¶Î£¬
                              uart_char(ECBM_STREAM_UART,ES_XMODEM_ACK);//·¢ËÍACK£¬Í¨ÖªÉÏÎ»»ú½ÓÊÕEOTÁË¡£
                              es_xmodem_status=ES_XMODEM_STOP;        //µ½Í£Ö¹×´Ì¬¡£
                          }else if(dat==ES_XMODEM_CAN){               //Èç¹ûÊÕµ½CAN×Ö¶Î£¬
                              es_xmodem_status=ES_XMODEM_STOP;        //Ìøµ½Í£Ö¹×´Ì¬¡£
                          }
                      }break;
                      case ES_XMODEM_READ_PACK:{//¶ÁÈ¡°ü±àºÅ¡£
                          es_xmodem_pack=dat;                     //½«µ±Ç°µÄÊý¾Ý°ü±àºÅ´æ×Å¡£
                          es_xmodem_sum+=dat;                     //¼ÆËãÐ£ÑéºÍ¡£
                          es_xmodem_status=ES_XMODEM_CHECK_PACK;  //Ìøµ½È·ÈÏ°ü±àºÅ¡£
                      }break;
                      case ES_XMODEM_CHECK_PACK:{//È·ÈÏ°ü±àºÅ¡£
                          if(es_xmodem_pack==(~dat)){                 //Èç¹û±àºÅµÄ·´ÂëÕýÈ·¡£
                              es_xmodem_status=ES_XMODEM_READ_MODE;   //Ìøµ½¶ÁÊý¾ÝÄ£Ê½¡£
                              es_xmodem_sum+=dat;                     //¼ÆËãÐ£ÑéºÍ¡£
                              es_xmodem_count=0;                      //ÖØÖÃ»º´æÖ¸Õë¡£
                              if(ecbm_stream_start>=(ECBM_STREAM_SZIE-1)){//ÆäÊµ¾ÍÊÇÅÐ¶Ï(start+1)>=szie¡£µ«ÊÇ»»³ÉÅÐ¶Ïsiz
             -e-1µÄ»°¿ÉÒÔ¹æ±Ü255+1Òç³öÎÊÌâ¡£
                                  es_xmodem_buf_start=0;              //Èç¹ûÈ·Êµ´óÓÚsizeÁË£¬¾Í´ÓÍ·¿ªÊ¼¡£
                              }else{                                  //·ñÔò¾Í¶¨Î»ÏÂÒ»Î»¡£
                                  es_xmodem_buf_start=ecbm_stream_start+1;//ÒòÎªµ±Ç°ÊÇ°ü±àºÅ·´Âë£¬ÏÂÒ»Î»²ÅÊÇÊý¾Ý¡£
                              }
                          }else{                                      //·´Âë²»ÕýÈ·ËµÃ÷²»ÊÇÖ¡Í·£¬
                              es_xmodem_status=ES_XMODEM_ERROR;       //Ìøµ½´íÎóÌ¬¡£
                          }            
                      }break;
C51 COMPILER V9.01   STREAM_XMODEM                                                         07/18/2022 16:31:20 PAGE 2   

                      case ES_XMODEM_READ_MODE:{//½ÓÊÕÊý¾ÝÄ£Ê½¡£
                          es_xmodem_sum+=dat;                         //¼ÆËãÐ£ÑéºÍ¡£
                          es_xmodem_count++;                          //»º´æÖ¸Õë¼ÓÒ»¡£
                          if(es_xmodem_count>=128){                   //Èç¹û½ÓÊÕÁË128¸öÊý¾Ý£¬
                              es_xmodem_status=ES_XMODEM_CHECK_DATA;  //½øÈë¼ì²âÊý¾ÝÐ£Ñé¡£
                          }                                           //Êý¾Ý¶¼ÔÚstream»º´æÀï£¬ÕâÀï²»ÓÃ¶îÍâ´¢´æ¡£
                      }break;
                      case ES_XMODEM_CHECK_DATA:{//¼ì²éÐ£ÑéºÍ¡£
                          if(dat==es_xmodem_sum){                     //Èç¹ûÐ£ÑéÕýÈ·£¬
                              for(i=0;i<128;i++){                     //X-modemÍ¨³£ÊÇÒ»¸ö°üÓÐ128×Ö½ÚµÄÊý¾Ý¡£
                                  es_xmodem_write_reg(es_xmodem_pack,i,ecbm_stream_buf[es_xmodem_buf_start]);//µ÷ÓÃÊý¾ÝÊ
             -äÈëº¯ÊýÀ´´¦ÀíÕâÐ©Êý¾Ý¡£
                                  es_xmodem_buf_start++;                      //Ã¿ÊäÈëÒ»¸öÊý¾Ý£¬±äÁ¿¾Í+1¡£
                                  if(es_xmodem_buf_start>=ECBM_STREAM_SZIE){  //µ±È»Ò²Òª·ÀÖ¹Òç³ö¡£
                                      es_xmodem_buf_start=0;                  //Òç³ö¾ÍÇåÁã¡£
                                  }
                              }
                              uart_char(ECBM_STREAM_UART,ES_XMODEM_ACK);         //·¢ËÍACK£¬Í¨ÖªÉÏÎ»»ú·¢ÏÂÒ»°ü¡£
                          }else{                                      //Èç¹ûÐ£Ñé²»ÕýÈ·£¬
                              uart_char(ECBM_STREAM_UART,ES_XMODEM_NAK);         //·¢ËÍNACK£¬Í¨ÖªÉÏÎ»»úÖØ·¢¡£
                          }           
                          es_xmodem_status=ES_XMODEM_READY;           //µ½ÁËÕâÒ»²½£¬ÕâÒ»Ö¡¾Í´¦ÀíÍêÁË£¬»Ö¸´µ½¾ÍÐ÷Ì¬¡£    
             -     
                      }break;
                  }
              }
              #endif  //ºÍ×îÉÏÃæµÄ#ifndefÅäºÏ³ÉÒ»¸ö³ÌÐò¶Î¡£
  79                  //ÒÔÒ»¸ö¿ÕÐÐÎª½áÎ²¡£


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
