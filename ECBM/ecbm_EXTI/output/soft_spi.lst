C51 COMPILER V9.01   SOFT_SPI                                                              07/18/2022 16:31:19 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE SOFT_SPI
OBJECT MODULE PLACED IN .\output\soft_spi.obj
COMPILER INVOKED BY: D:\Paths\Keil_v5\C51\BIN\C51.EXE ECBM_LIB\soft_spi.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\ECBM_L
                    -IB;.\device) DEBUG OBJECTEXTEND PRINT(.\output\soft_spi.lst) OBJECT(.\output\soft_spi.obj)

line level    source

   1          #include "ecbm_core.h"//Í³Ò»¼ÓÔØºËĞÄÍ·ÎÄ¼ş
   2          #if ECBM_SOFTSPI_LIB_EN//¼ì²é±¾¿âÓĞÃ»ÓĞ±»Ê¹ÄÜ
              u8 idata soft_spi_def_clk_port;
              u8 idata soft_spi_def_clk_pin;
              u8 idata soft_spi_def_mosi_port;
              u8 idata soft_spi_def_mosi_pin;
              u8 idata soft_spi_def_miso_port;
              u8 idata soft_spi_def_miso_pin;
              u8 idata soft_spi_mode=0;
              u8 xdata soft_spi_index=0;
              u8 xdata soft_spi_max=0;
              /*-------------------------------------------------------
              Èí¼şSPIÒı½ÅÇĞ»»º¯Êı¡£
              -------------------------------------------------------*/
              void soft_spi_set_pin(soft_spi_def * dev){
                  if(soft_spi_index!=dev->dev_id){                  //ÅĞ¶ÏIDºÅ£¬¿ÉÒÔ¼ÓËÙ8us@24MHzµÄÊ±¼ä¡£
                      soft_spi_def_clk_port =io2port(dev->clk_pin); //½âÑ¹Ê±ÖÓ½ÅµÄP¿Ú¡£
                      soft_spi_def_clk_pin  =io2pin (dev->clk_pin); //½âÑ¹Ê±ÖÓ½ÅµÄIO¿Ú¡£
                      soft_spi_def_mosi_port=io2port(dev->mosi_pin);//½âÑ¹Êı¾İÊä³ö½ÅµÄP¿Ú¡£
                      soft_spi_def_mosi_pin =io2pin (dev->mosi_pin);//½âÑ¹Êı¾İÊä³ö½ÅµÄIO¿Ú¡£
                      soft_spi_def_miso_port=io2port(dev->miso_pin);//½âÑ¹Êı¾İÊäÈë½ÅµÄP¿Ú¡£
                      soft_spi_def_miso_pin =io2pin (dev->miso_pin);//½âÑ¹Êı¾İÊäÈë½ÅµÄIO¿Ú¡£
                      soft_spi_mode=dev->mode;                      //ÉèÖÃÄ£Ê½¡£
                      soft_spi_index=dev->dev_id;                   //ÇĞ»»ID¡£
                  }    
              }
              /*-------------------------------------------------------
              Èí¼şSPI³õÊ¼»¯º¯Êı¡£
              -------------------------------------------------------*/
              void soft_spi_init(soft_spi_def * dev,u8 clk,u8 mosi,u8 miso,u8 mode){
                  dev->clk_pin =clk;             //±£´æÊ±ÖÓ½ÅĞÅÏ¢¡£
                  dev->mosi_pin=mosi;            //±£´æÊı¾İÊä³ö½ÅĞÅÏ¢¡£
                  dev->miso_pin=miso;            //±£´æÊı¾İÊäÈë½ÅĞÅÏ¢¡£
                  dev->mode    =mode;            //±£´æÄ£Ê½ĞÅÏ¢¡£
                  gpio_mode(clk, GPIO_OUT);      //Ê±ÖÓ½ÅÉèÖÃÎªÍÆÍì¡£
                  if(mode&SOFT_SPI_CPOL_MASK){   //²é¿´Ê±ÖÓ¼«ĞÔÉèÖÃ£¬
                      gpio_out(clk,1);           //¼«ĞÔÊÇ¸ßµçÆ½¾ÍÏÈÖÃ¸ß£¬
                  }else{
                      gpio_out(clk,0);           //¼«ĞÔÊÇµÍµçÆ½¾ÍÏÈÖÃµÍ¡£
                  }
                  if(mode&SOFT_SPI_MOSI_EN_MASK){//²é¿´MOSIÊ¹ÄÜ£¬
                      gpio_mode(mosi,GPIO_OUT);  //Ê¹ÄÜÁË¾ÍÉèÖÃÎªÍÆÍìÄ£Ê½¡£
                      gpio_out (mosi,1);         //Ä¬ÈÏ¸ßµçÆ½¡£
                  }
                  if(mode&SOFT_SPI_MISO_EN_MASK){//²é¿´MISOÊ¹ÄÜ£¬
                      gpio_mode  (miso,GPIO_IN); //Ê¹ÄÜÁË¾ÍÉèÖÃÎªÈõÉÏÀ­Ä£Ê½¡£
                      gpio_out   (miso,1);       //Ä¬ÈÏ¸ßµçÆ½¡£
                  }
                  dev->dev_id=++soft_spi_max;    //»ñÈ¡IDºÅ¡£
                  soft_spi_set_pin(dev);         //ÉèÖÃ²ÎÊıµ½ÏµÍ³¡£
              } 
              /*-------------------------------------------------------
              Èí¼şSPIÒı½ÅÇĞ»»º¯Êı£¨ÄÚÁª°æ£©¡£
              -------------------------------------------------------*/
C51 COMPILER V9.01   SOFT_SPI                                                              07/18/2022 16:31:19 PAGE 2   

              void soft_spi_set_pin_linkage(u8 id,u8 clk,u8 mosi,u8 miso,u8 mode){
                  if(soft_spi_index!=id){                    //ÅĞ¶ÏIDºÅ£¬¿ÉÒÔ¼ÓËÙ8us@24MHzµÄÊ±¼ä¡£
                      soft_spi_def_clk_port =io2port(clk);   //½âÑ¹Ê±ÖÓ½ÅµÄP¿Ú¡£
                      soft_spi_def_clk_pin  =io2pin (clk);   //½âÑ¹Ê±ÖÓ½ÅµÄIO¿Ú¡£
                      soft_spi_def_mosi_port=io2port(mosi);  //½âÑ¹Êı¾İÊä³ö½ÅµÄP¿Ú¡£
                      soft_spi_def_mosi_pin =io2pin (mosi);  //½âÑ¹Êı¾İÊä³ö½ÅµÄIO¿Ú¡£
                      soft_spi_def_miso_port=io2port(miso);  //½âÑ¹Êı¾İÊäÈë½ÅµÄP¿Ú¡£
                      soft_spi_def_miso_pin =io2pin (miso);  //½âÑ¹Êı¾İÊäÈë½ÅµÄIO¿Ú¡£
                      soft_spi_mode=mode;                    //ÉèÖÃÄ£Ê½¡£
                      soft_spi_index=id;                     //ÇĞ»»ID¡£
                  }    
              }
              /*-------------------------------------------------------
              Èí¼şSPI³õÊ¼»¯º¯Êı£¨ÄÚÁª°æ£©¡£
              -------------------------------------------------------*/
              u8 soft_spi_init_linkage(u8 clk,u8 mosi,u8 miso,u8 mode){
                  u8 id;                         //Î¨Ò»IDºÅ
                  gpio_mode(clk, GPIO_OUT);      //Ê±ÖÓ½ÅÉèÖÃÎªÍÆÍì¡£
                  if(mode&SOFT_SPI_CPOL_MASK){   //²é¿´Ê±ÖÓ¼«ĞÔÉèÖÃ£¬
                      gpio_out(clk,1);           //¼«ĞÔÊÇ¸ßµçÆ½¾ÍÏÈÖÃ¸ß£¬
                  }else{
                      gpio_out(clk,0);           //¼«ĞÔÊÇµÍµçÆ½¾ÍÏÈÖÃµÍ¡£
                  }
                  if(mode&SOFT_SPI_MOSI_EN_MASK){//²é¿´MOSIÊ¹ÄÜ£¬
                      gpio_mode(mosi,GPIO_OUT);  //Ê¹ÄÜÁË¾ÍÉèÖÃÎªÍÆÍìÄ£Ê½¡£
                      gpio_out (mosi,1);         //Ä¬ÈÏ¸ßµçÆ½¡£
                  }
                  if(mode&SOFT_SPI_MISO_EN_MASK){//²é¿´MISOÊ¹ÄÜ£¬
                      gpio_mode  (miso,GPIO_IN); //Ê¹ÄÜÁË¾ÍÉèÖÃÎªÈõÉÏÀ­Ä£Ê½¡£
                      gpio_out   (miso,1);       //Ä¬ÈÏ¸ßµçÆ½¡£
                  }
                  id =++soft_spi_max;            //»ñÈ¡IDºÅ¡£
                  soft_spi_set_pin_linkage(id,clk,mosi,miso,mode);//ÉèÖÃ²ÎÊıµ½ÏµÍ³¡£
                  return id;                       //·µ»ØIDºÅ¡£
              } 
              /*-------------------------------------------------------
              Èí¼şSPI·¢ËÍ/½ÓÊÕº¯Êı¡£
              -------------------------------------------------------*/
              u8 soft_spi_send(u8 dat){
                  u8 i,j,k=0;
                  if(soft_spi_mode&SOFT_SPI_CPOL_MASK){                           //¶ÁÈ¡Ê±ÖÓ¼«ĞÔ²ÎÊı¡£
                      gpio_out_fast(soft_spi_def_clk_port,soft_spi_def_clk_pin,1);//¸ù¾İ²ÎÊıÉèÖÃÒ»ÏÂIOµÄ³õÊ¼×´Ì¬¡£
                  }else{
                      gpio_out_fast(soft_spi_def_clk_port,soft_spi_def_clk_pin,0);//Ä¿µÄÊÇÎªÁË·ÀÖ¹¶àÒı½Å¸´ÓÃÏÂµÄµçÆ½´íÎ»
             -¡£
                  }
                  if(soft_spi_mode&SOFT_SPI_MSB_LSB_MASK){//Èç¹ûÊÇÏÈ·¢¸ßÎ»¡£
                      i=0x80;
                      for(j=0;j<8;j++){                   //8Î»µÄÊı¾İ¡£
                          if(dat&i){                      //¸ù¾İµ±Ç°Î»¾ö¶¨Êä³öµçÆ½¡£
                              gpio_out_fast(soft_spi_def_mosi_port,soft_spi_def_mosi_pin,1);
                          }else{
                              gpio_out_fast(soft_spi_def_mosi_port,soft_spi_def_mosi_pin,0);
                          }
                          gpio_toggle_fast(soft_spi_def_clk_port,soft_spi_def_clk_pin);//Ê±ÖÓ½ÅµÚÒ»´Î·­×ª¡£
                          if((soft_spi_mode&SOFT_SPI_MISO_EN_MASK)&&((soft_spi_mode&SOFT_SPI_CPHA_MASK)==0)){//¶ÁÈ¡Ê±ÖÓÏ
             -àÎ»ÉèÖÃ¡£
                              if(gpio_in_fast(soft_spi_def_miso_port,soft_spi_def_miso_pin)){//ÉèÖÃÊÇµÚÒ»´Î·­×ª¶ÁµÄ»°£¬¾
             -Í¶ÁMISO½Å¡£
                                  k|=i;//½«MISO½ÅµÄÊı¾İ´æÈëÁÙÊ±±äÁ¿Àï¡£
                              }
                          }
C51 COMPILER V9.01   SOFT_SPI                                                              07/18/2022 16:31:19 PAGE 3   

                          gpio_toggle_fast(soft_spi_def_clk_port,soft_spi_def_clk_pin);//Ê±ÖÓ½ÅµÚ¶ş´Î·­×ª¡£
                          if((soft_spi_mode&SOFT_SPI_MISO_EN_MASK)&&((soft_spi_mode&SOFT_SPI_CPHA_MASK)==1)){//¶ÁÈ¡Ê±ÖÓÏ
             -àÎ»ÉèÖÃ¡£
                              if(gpio_in_fast(soft_spi_def_miso_port,soft_spi_def_miso_pin)){//ÉèÖÃÊÇµÚ¶ş´Î·­×ª¶ÁµÄ»°£¬¾
             -Í¶ÁMISO½Å¡£
                                  k|=i;//½«MISO½ÅµÄÊı¾İ´æÈëÁÙÊ±±äÁ¿Àï¡£
                              }
                          }
                          i>>=1;
                      }
                  }else{                                  //Èç¹ûÊÇÏÈ·¢µÍÎ»
                      i=0x01;
                      for(j=0;j<8;j++){                  //8Î»µÄÊı¾İ¡£
                          if(dat&i){                     //¸ù¾İµ±Ç°Î»¾ö¶¨Êä³öµçÆ½¡£
                              gpio_out_fast(soft_spi_def_mosi_port,soft_spi_def_mosi_pin,1);
                          }else{
                              gpio_out_fast(soft_spi_def_mosi_port,soft_spi_def_mosi_pin,0);
                          }
                          gpio_toggle_fast(soft_spi_def_clk_port,soft_spi_def_clk_pin);//Ê±ÖÓ½ÅµÚÒ»´Î·­×ª¡£
                          if((soft_spi_mode&SOFT_SPI_MISO_EN_MASK)&&((soft_spi_mode&SOFT_SPI_CPHA_MASK)==0)){//¶ÁÈ¡Ê±ÖÓÏ
             -àÎ»ÉèÖÃ¡£
                              if(gpio_in_fast(soft_spi_def_miso_port,soft_spi_def_miso_pin)){//ÉèÖÃÊÇµÚÒ»´Î·­×ª¶ÁµÄ»°£¬¾
             -Í¶ÁMISO½Å¡£
                                  k|=i;//½«MISO½ÅµÄÊı¾İ´æÈëÁÙÊ±±äÁ¿Àï¡£
                              }
                          }
                          gpio_toggle_fast(soft_spi_def_clk_port,soft_spi_def_clk_pin);
                          if((soft_spi_mode&SOFT_SPI_MISO_EN_MASK)&&((soft_spi_mode&SOFT_SPI_CPHA_MASK)==1)){//¶ÁÈ¡Ê±ÖÓÏ
             -àÎ»ÉèÖÃ¡£
                              if(gpio_in_fast(soft_spi_def_miso_port,soft_spi_def_miso_pin)){//ÉèÖÃÊÇµÚ¶ş´Î·­×ª¶ÁµÄ»°£¬¾
             -Í¶ÁMISO½Å¡£
                                  k|=i;//½«MISO½ÅµÄÊı¾İ´æÈëÁÙÊ±±äÁ¿Àï¡£
                              }
                          }
                          i<<=1;
                      }
                  }
                  return k;//·µ»Ø»º´æÖµ¡£
              }
              #endif  //ºÍ×îÉÏÃæµÄ#ifndefÅäºÏ³ÉÒ»¸ö³ÌĞò¶Î¡£
 148                  //ÒÔÒ»¸ö¿ÕĞĞÎª½áÎ²¡£


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
